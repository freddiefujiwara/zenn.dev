---
title: "GASã§OGPç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹: Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ã—ã¦PNGã‚’è¿”ã™Web API"
emoji: "ğŸ–¼ï¸"
type: "tech"
topics: ["gas", "googleappscripts", "ogp", "slides"]
published: false
---

## æƒ³å®šèª­è€…ï¼ˆå‰æçŸ¥è­˜ï¼‰
- Google Apps Scriptï¼ˆGASï¼‰ã®åŸºæœ¬ï¼ˆ`doGet` ã§Webã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã€`ContentService` ãŒåˆ†ã‹ã‚‹ï¼‰
- Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ã—ã¦æ‰±ã†ç™ºæƒ³ã‚’æŒã£ã¦ã„ã‚‹
- JavaScriptã®åŸºç¤æ–‡æ³•ãŒèª­ã‚ã‚‹

[ã‚½ãƒ¼ã‚¹](https://github.com/freddiefujiwara/ogp-png-gas)

## ã“ã®è¨˜äº‹ã§æ‰±ã†ãƒ„ãƒ¼ãƒ«ã®æ¦‚è¦
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ„ãƒ¼ãƒ«ã¯ã€**Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦OGPç”»åƒï¼ˆPNGï¼‰ã‚’ç”Ÿæˆã—ã€Webã‚¢ãƒ—ãƒªã¨ã—ã¦Base64ã§è¿”ã™**GASã§ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—åˆ—ã‚’GETãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›ã—ã€PNGã‚’æ›¸ãå‡ºã—ã¦JSONã§è¿”ã™æµã‚Œã«ãªã£ã¦ã„ã¾ã™ã€‚

### ã©ã‚“ãªèª²é¡Œã‚’è§£æ±ºã™ã‚‹ï¼Ÿ
- ãƒ–ãƒ­ã‚°ã‚„è¨˜äº‹ã®OGPç”»åƒã‚’æ¯å›æ‰‹ä½œæ¥­ã§ä½œã‚‹ã®ãŒé¢å€’
- OGPç”»åƒã‚’Web APIã¨ã—ã¦è‡ªå‹•ç”Ÿæˆã—ãŸã„
- æ—¥æœ¬èªãƒ»è‹±èªã®æ··åœ¨ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚‚ã€é•·ã•ã‚’è¦‹ã¦é©åˆ‡ã«åˆ‡ã‚Šè©°ã‚ãŸã„

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€**Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®ã€Œãƒ‡ã‚¶ã‚¤ãƒ³ã—ã‚„ã™ã•ã€**ã¨ã€**GASã®ã€Œç°¡æ˜“ãªWeb APIåŒ–ã€**ã‚’çµ„ã¿åˆã‚ã›ã€ä¸Šè¨˜ã®èª²é¡Œã‚’ã¾ã¨ã‚ã¦è§£æ±ºã—ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨å‡¦ç†ãƒ•ãƒ­ãƒ¼
### 1. Webã‚¢ãƒ—ãƒªå…¥å£ï¼ˆ`doGet`ï¼‰
`doGet` ã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `t` ã‚’å—ã‘å–ã‚Šã€æ”¹è¡Œé™¤å»â†’æ–‡å­—æ•°èª¿æ•´â†’OGPç”Ÿæˆâ†’JSONè¿”å´ã¾ã§ã‚’æ‹…å½“ã—ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã¯ `error` ã¨ `details` ã‚’JSONã§è¿”ã™è¨­è¨ˆã§ã™ã€‚

```js
export function doGet(e) {
  let title = (e && e.parameter && e.parameter.t) || "No Title";

  // Process the title
  title = replaceNewlines(title);
  title = truncateToWeightedLength(title, 66);

  try {
    const base64Image = generateOgpImage(title);
    const output = JSON.stringify({ png: base64Image });
    return ContentService.createTextOutput(output)
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('Failed to generate OGP image:', error);
    return ContentService.createTextOutput(JSON.stringify({
      error: 'Failed to generate image',
      details: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
```

### 2. ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰PNGã‚’ç”Ÿæˆ
`generateOgpImage` ã¯ã€**Googleã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚³ãƒ”ãƒ¼ â†’ ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç½®æ› â†’ PNGæ›¸ãå‡ºã—**ã®é †ã«å‡¦ç†ã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬IDã¯è¨­å®šå€¤ã§å›ºå®šã—ã€ã‚³ãƒ”ãƒ¼å¾Œã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšå‰Šé™¤ã™ã‚‹ã‚ˆã† `finally` ã§æƒé™¤ã—ã¦ã„ã¾ã™ã€‚

```js
function generateOgpImage(title) {
  const templateFile = DriveApp.getFileById(CONFIG.TEMPLATE_ID);
  const tempFile = templateFile.makeCopy(CONFIG.TEMP_FILE_NAME);
  const tempId = tempFile.getId();

  try {
    const presentation = SlidesApp.openById(tempId);
    const slide = presentation.getSlides()[0];

    // Replace placeholder with actual title
    slide.replaceAllText(CONFIG.PLACEHOLDER, title);
    presentation.saveAndClose();

    // Export the slide as PNG using the thumbnail export URL
    const url = `https://docs.google.com/presentation/d/${tempId}/export/png`;
    const options = {
      headers: { Authorization: "Bearer " + ScriptApp.getOAuthToken() }
    };
    const response = UrlFetchApp.fetch(url, options);
    const blob = response.getBlob().setName(CONFIG.OUTPUT_FILE_NAME);

    return Utilities.base64Encode(blob.getBytes());
  } finally {
    // Ensure the temporary file is deleted even if an error occurs
    tempFile.setTrashed(true);
  }
}
```

### 3. ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—æ•°åˆ¶é™ï¼ˆæ—¥æœ¬èª/è‹±èªã®é‡ã¿ä»˜ã‘ï¼‰
OGPã®è¦‹æ „ãˆã‚’å®ˆã‚‹ãŸã‚ã€ã‚¿ã‚¤ãƒˆãƒ«ã¯**ã€Œå…¨è§’1.65 / åŠè§’1.0ã€ã®é‡ã¿**ã§é•·ã•è¨ˆç®—ã—ã€æœ€å¤§66ç›¸å½“ã¾ã§åˆ‡ã‚Šè©°ã‚ã¾ã™ã€‚ã¾ãŸæ”¹è¡Œã¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚

```js
export function truncateToWeightedLength(str, maxWeight) {
  if (!str) return '';
  let currentWeight = 0;
  let result = '';
  for (let i = 0; i < str.length; i++) {
    const char = str[i];
    const charCode = char.charCodeAt(0);
    const weight = ((charCode >= 0x0000 && charCode <= 0x007F) || (charCode >= 0xFF61 && charCode <= 0xFF9F)) ? 1 : 1.65;

    if (currentWeight + weight <= maxWeight + 0.0001) {
      result += char;
      currentWeight += weight;
    } else {
      break;
    }
  }
  return result;
}
```

## åˆ©ç”¨ã‚·ãƒ¼ãƒ³
- ãƒ–ãƒ­ã‚°åŸ·ç­†æ™‚ã«è‡ªå‹•ã§OGPç”»åƒã‚’ç”Ÿæˆ
- CMSã®ãƒ“ãƒ«ãƒ‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰GAS Webã‚¢ãƒ—ãƒªã‚’å©ã„ã¦ç”»åƒã‚’ç”Ÿæˆ
- è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆã™ã‚‹A/Bãƒ†ã‚¹ãƒˆç”¨ã®OGPä½œæˆ

## GASç‰¹æœ‰ã®æ³¨æ„ç‚¹
### æ¨©é™ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
ã“ã®å‡¦ç†ã§ã¯ **DriveApp / SlidesApp / UrlFetchApp** ã‚’ä½¿ã†ãŸã‚ã€åˆå›å®Ÿè¡Œæ™‚ã«ã“ã‚Œã‚‰ã®æ¨©é™è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã‚³ãƒ”ãƒ¼ã‚„PNGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒã‚ã‚‹ãŸã‚ã€é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸ã—ãªã„ã¨å¤±æ•—ã—ã¾ã™ã€‚

### å®Ÿè¡Œæ™‚é–“åˆ¶é™
GASã®Webã‚¢ãƒ—ãƒªã¯å®Ÿè¡Œæ™‚é–“ã«ä¸Šé™ãŒã‚ã‚‹ãŸã‚ã€
- ãƒ†ãƒ³ãƒ—ãƒ¬ã¯è»½é‡ã«ã™ã‚‹
- ç”»åƒç”Ÿæˆå›æ•°ã‚’æŠ‘ãˆã‚‹
- ä¸è¦ãªã‚¹ãƒ©ã‚¤ãƒ‰ã¯å‰Šé™¤ã™ã‚‹
ã¨ã„ã£ãŸå·¥å¤«ãŒå¿…è¦ã§ã™ã€‚å‡¦ç†ãŒé‡ããªã‚‹ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šå¾—ã¾ã™ï¼ˆä¸€èˆ¬çš„ã«ã¯6åˆ†ï¼‰ã€‚

### Webã‚¢ãƒ—ãƒªã¨ã—ã¦ã®ãƒ‡ãƒ—ãƒ­ã‚¤
READMEã®é€šã‚Šã€`clasp` ã‚’ä½¿ã£ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹ã™ã‚‹ã“ã¨ã§ã€GETãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¸¡ã—ã¦ç”»åƒã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

### ãƒ­ã‚°ã¨ä¾‹å¤–å‡¦ç†
`doGet` ã§ã¯ä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒã—ã€JSONã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™è¨­è¨ˆã§ã™ã€‚`console.error` ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€GASã®å®Ÿè¡Œãƒ­ã‚°ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã§ãã¾ã™ã€‚

## ä½¿ã„æ–¹ï¼ˆAPIã¨ã—ã¦å©ãï¼‰
Webã‚¢ãƒ—ãƒªURLã« `t` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã›ã°OKã§ã™ã€‚READMEã«ã‚ã‚‹é€šã‚Šã€Base64ã®PNGãŒè¿”ã£ã¦ãã¾ã™ã€‚

```bash
curl -L "https://script.google.com/macros/s/.../exec?t=Your+Title+Here"
```

æˆ»ã‚Šå€¤ã®JSONä¾‹ï¼š
```json
{
  "png": "iVBORw0KGgoAAAANSUhEUgAA..."
}
```

## é‹ç”¨ã®ã‚³ãƒ„
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**ï¼šIDã‚’å›ºå®šã™ã‚‹ãªã‚‰ã€èª¤ã£ã¦ç·¨é›†ã—ãªã„ã‚ˆã†å…±æœ‰æ¨©é™ã‚’æœ€å°åŒ–ã™ã‚‹
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ¤œè¨**ï¼šåŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤šç”¨ã™ã‚‹ãªã‚‰ã€ç”Ÿæˆçµæœã‚’PropertiesServiceç­‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **ã‚¨ãƒ©ãƒ¼ç›£è¦–**ï¼š`console.error` ã®ãƒ­ã‚°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã§å®šæœŸç¢ºèªã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚‹

## ã¾ã¨ã‚
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’OGPãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ‰±ã„ã€GAS Webã‚¢ãƒ—ãƒªã§**å³æ™‚ã«PNGã‚’ç”Ÿæˆã—ã¦è¿”ã™**ã‚·ãƒ³ãƒ—ãƒ«ãªä»•çµ„ã¿ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ã®ãƒ‡ã‚¶ã‚¤ãƒ³è‡ªç”±åº¦ã¨GASã®Web APIåŒ–ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€OGPç”Ÿæˆã‚’è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚

## é‹ç”¨ãƒ»æ‹¡å¼µã‚¢ã‚¤ãƒ‡ã‚¢
- **è¤‡æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œ**ï¼šã‚¯ã‚¨ãƒªã§ãƒ†ãƒ³ãƒ—ãƒ¬IDã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åˆ¥ã®OGPã«å¯¾å¿œï¼‰
- **ç”»åƒã‚µã‚¤ã‚ºã®å¯å¤‰åŒ–**ï¼šç”¨é€”åˆ¥ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚µã‚¤ã‚ºã‚’å¤‰ãˆã¦è¤‡æ•°ã‚µã‚¤ã‚ºã‚’å‡ºåŠ›
- **ãƒ­ã‚´å·®ã—è¾¼ã¿**ï¼šDriveä¸Šã®ç”»åƒã‚’å·®ã—è¾¼ã¿ã€ãƒ–ãƒ©ãƒ³ãƒ‰è¦ç´ ã‚’è‡ªå‹•åˆæˆ
- **APIã‚­ãƒ¼æ¤œè¨¼**ï¼šå¤–éƒ¨å…¬é–‹æ™‚ã«ç°¡æ˜“çš„ãªèªè¨¼ã‚’è¿½åŠ ã—ã€ä¸æ­£åˆ©ç”¨ã‚’æŠ‘æ­¢
