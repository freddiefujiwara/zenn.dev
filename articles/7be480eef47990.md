---
title: "私が作った「Markdown→画像化」ツールを技術解説してみた"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["markdown","tips","Vue"]
published: true
---

こんにちは。今回は**私が作った**「Markdownを画像に変換するWebアプリ（md2img）」について、技術的に優れているポイントをZenn向けにわかりやすくまとめます。  
単なる紹介ではなく、**ソースコードの具体例**も交えながら解説していきます。

- [ツール](https://freddiefujiwara.com/md2img/)
- [ソースコード](https://github.com/freddiefujiwara/md2img/)
---

## どんなツール？

このアプリは、Markdownを入力するとプレビューが表示され、**PNG画像として書き出せる**ツールです。  
SNS投稿・OGP画像・資料化などで「Markdownを画像で配りたい」という用途に向いています。

---

## 技術的に工夫したポイント

### 1. DOMの実測に基づくページ分割（安定してきれいに割れる）

MarkdownはHTMLに変換してから描画しますが、1枚の画像に収まらない場合は**ページ分割**が必要です。  
ここで「文字数で割る」などの雑な方法ではなく、**実際のDOM高さを計測して分割**しています。

```js
export function paginateHtml({ html, maxHeight, measure, doc = document }) {
  if (typeof measure !== "function") {
    throw new Error("measure function is required to paginate");
  }

  const blocks = splitIntoBlocks(html, doc);
  const pages = [];
  let current = "";

  for (const block of blocks) {
    const candidate = current + block;
    const height = measure(candidate);

    if (height > maxHeight) {
      if (!current) {
        pages.push(block);
        current = "";
      } else {
        pages.push(current);
        current = block;
      }
    } else {
      current = candidate;
    }
  }

  if (current) pages.push(current);

  return pages.length ? pages : [html];
}
```

「DOMで測って、超えたらページを切る」という堅実なロジックなので、  
**見出しや段落が途中で切れにくく**、読みやすい画像になります。  

---

### 2. 表示用と計測用のDOMを分離（UIが乱れない）

ページ分割のために高さ計測を行うとき、表示中のDOMを使うとレイアウトが乱れることがあります。  
そこで、**見えないDOMを別に用意して計測**しています。

```vue
<div class="fixed -left-[99999px] top-0 opacity-0 pointer-events-none">
  <div ref="measureWrapRef" class="overflow-hidden" :style="pageStyle">
    <div ref="measureContentRef"></div>
  </div>
</div>
```

この設計のおかげで、**ユーザーの画面は安定したまま**正確な計測ができます。  

---

### 3. 画像化の流れと、モバイル共有まで考慮

画像化は `html2canvas` を使ってページ単位で行います。  
その際、**フォント読み込みの待機**や**モバイルの共有API**に対応しているのがポイントです。

```js
// Wait for web fonts.
if ("fonts" in document) await document.fonts.ready;

// Capture each page.
for (let i = 0; i < pagesHtml.value.length; i++) {
  await nextTick();
  captureNode.querySelector(".md-body").innerHTML = pagesHtml.value[i];
  const canvas = await html2canvas(captureNode, {
    backgroundColor: null,
    scale,
    useCORS: true,
  });
  // ... 省略 ...
}
```

「画像にするとフォントがズレる」「モバイルから共有できない」などの悩みを最初から潰しています。  

---

### 4. デバウンスでUIの再計算を最適化

Markdownの入力やスライダー操作で毎回ページ計算すると重くなります。  
そこで、**デバウンス処理**で入力の安定後に一度だけ再計算するようにしています。

```js
export function createDebounce(fn, delay = 0) {
  if (typeof fn !== "function") {
    throw new Error("fn must be a function");
  }

  let timerId;
  const debounced = (...args) => {
    clearTimeout(timerId);
    timerId = setTimeout(() => {
      fn(...args);
    }, delay);
  };

  debounced.cancel = () => clearTimeout(timerId);

  return debounced;
}
```

「入力している間は軽く、止まったら再計算する」というUXを実現できます。  

---

### 5. URL共有でMarkdownをそのまま引き継げる

Markdown本文をURLにエンコードして保存することで、  
**URLを共有すれば同じ内容を再現できる**ようにしています。

```js
const buildEncodedPath = (value) => (value ? `/${encodeURIComponent(value)}` : "/");

watch(markdownInput, async (value) => {
  if (!isReady.value) return;
  const targetPath = buildEncodedPath(value);
  if (route.path !== targetPath) {
    await router.replace({ path: targetPath });
  }
});
```

この仕組みで、「編集した内容をそのまま他人に見せる」ことが簡単になっています。  

---

## まとめ

このmd2imgは、**私自身が使うことも想定して作ったツール**なので、  
使い勝手と品質はいまいちかもしれませんが。特に以下の点が強みです。

- DOM計測で正確なページ分割
- 計測用DOMの分離でUIを安定化
- フォント待機＋モバイル共有など実運用向け設計
- デバウンスで操作の快適さを維持
- URL共有で再利用性を確保

もし「Markdownを画像化したい」「同じような機能を作りたい」という方の参考になれば嬉しいです。
