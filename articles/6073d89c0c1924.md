---
title: "gh-pages + GASã§å®Ÿè£…ã™ã‚‹Google OAuthèªè¨¼ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["gh-pages","GAS","OAuth","google"]
published: true
---
## ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã§ã¯ã€**GitHub Pagesï¼ˆgh-pagesï¼‰ã§é…ä¿¡ã™ã‚‹Vue SPA**ã«å¯¾ã—ã¦ã€**Google Apps Scriptï¼ˆGASï¼‰ã‚’èªè¨¼ã‚²ãƒ¼ãƒˆå…¼APIã¨ã—ã¦ä½¿ã†**æ§‹æˆã‚’ã€èªè¨¼ã«çµã£ã¦è§£èª¬ã—ã¾ã™ã€‚

å¯¾è±¡ã¯æ¬¡ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã™ã€‚

- ç‹¬è‡ªã‚µãƒ¼ãƒãƒ¼ã¯æŒãŸãšã«å…¬é–‹ã—ãŸã„
- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§é–²è¦§åˆ¶å¾¡ã—ãŸã„
- ãƒ•ãƒ­ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’GASã§å³å¯†ã«æ¤œè¨¼ã—ãŸã„

å®Ÿè£…ã®è¦ç‚¹ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã§å–å¾—ã—ãŸ`id_token`ã‚’GASã¸æ¸¡ã—ã€GASå´ã§`iss`/`aud`/`exp`/`email_verified`/è¨±å¯ãƒ¡ãƒ¼ãƒ«ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ã™ã€‚

---

## ä½¿ç”¨æŠ€è¡“

- **Google Cloud Consoleï¼ˆOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆï¼‰**
- **Google Identity Servicesï¼ˆGISï¼‰**: ãƒ–ãƒ©ã‚¦ã‚¶ã§Googleãƒ­ã‚°ã‚¤ãƒ³ã—`id_token`ã‚’å–å¾—
- **Google Apps Scriptï¼ˆWebã‚¢ãƒ—ãƒªï¼‰**: `id_token`æ¤œè¨¼ã¨è¨±å¯åˆ¤å®š
- **GitHub Pages**: ãƒ•ãƒ­ãƒ³ãƒˆé…ä¿¡
- **Vue 3 + Pinia**: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¨APIé€šä¿¡ç®¡ç†

---

## æŠ€è¡“çš„ãªå·¥å¤«ç‚¹ï¼ˆèªè¨¼ã«ç‰¹åŒ–ï¼‰

### 1. Google OAuthã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å…ˆã«å›ºã‚ã‚‹
æœ€åˆã«Google Cloud Consoleã§OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

#### æ‰‹é †
1. Google Cloudã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
2. OAuthåŒæ„ç”»é¢ã‚’è¨­å®šï¼ˆå¿…è¦æƒ…å ±ã‚’å…¥åŠ›ï¼‰
3. OAuth 2.0 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼ˆWebã‚¢ãƒ—ãƒªï¼‰ã‚’ä½œæˆ
4. ãƒ•ãƒ­ãƒ³ãƒˆå´ã¸ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¨­å®š

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ•ãƒ­ãƒ³ãƒˆã®ç’°å¢ƒå¤‰æ•°ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```bash
# .env.local
VITE_GOOGLE_CLIENT_ID=your-web-client-id.apps.googleusercontent.com
```

`App.vue`ã§ã¯ã“ã®å€¤ã‚’å‚ç…§ã—ã€æœªè¨­å®šæ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤ºæ™‚ã«è­¦å‘Šã—ã¾ã™ã€‚

```js
// src/App.vue
const googleClientId = import.meta.env.VITE_GOOGLE_CLIENT_ID || "";
const hasGoogleClientId = computed(() => Boolean(googleClientId));
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚Šã€ä¿å­˜ã—ã¦APIã¸æ¸¡ã™
GISãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«`credential`ï¼ˆIDãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’å—ã‘å–ã‚Šã€`localStorage`ã¸ä¿å­˜ã—ã¾ã™ã€‚

```js
// src/App.vue
function handleGoogleCredential(response) {
  const credential = response?.credential;
  if (!credential) {
    return;
  }
  localStorage.setItem(ID_TOKEN_STORAGE_KEY, credential);
  idToken.value = credential;
  portfolioStore.fetchPortfolio();
}
```

APIå‘¼ã³å‡ºã—æ™‚ã¯ã€`id_token`ã‚’ã‚¯ã‚¨ãƒªã¨ã—ã¦ä»˜ä¸ã—ã¾ã™ã€‚

```js
// src/stores/portfolio.js
function buildApiUrlWithToken() {
  const idToken = getGoogleIdToken();
  if (!idToken) {
    return API_URL;
  }

  const url = new URL(API_URL);
  url.searchParams.set("id_token", idToken);
  return url.toString();
}
```

> gh-pagesé…ä¿¡ã§ã¯ã€`Authorization`ãƒ˜ãƒƒãƒ€ãƒ¼é‹ç”¨ã‚ˆã‚Šã‚¯ã‚¨ãƒªé‹ç”¨ã®æ–¹ãŒCORS/ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã§è©°ã¾ã‚Šã«ãã„ã§ã™ã€‚

### 3. GASã§ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºã‚’ãƒ˜ãƒƒãƒ€ãƒ¼/ã‚¯ã‚¨ãƒªä¸¡å¯¾å¿œã«ã™ã‚‹
GASå´ã§ã¾ãšãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã¾ã™ã€‚`Authorization: Bearer ...`ãŒã‚ã‚Œã°å„ªå…ˆã—ã€ãªã‘ã‚Œã°`id_token`ã‚¯ã‚¨ãƒªã‚’ä½¿ã„ã¾ã™ã€‚

```js
// GAS: Code.gs
function extractIdToken_(event) {
  const headers = event?.headers || {};
  const auth = headers.Authorization || headers.authorization || '';
  const bearer = auth.match(/^Bearer\s+(.+)$/i);
  if (bearer) return bearer[1];

  return event?.parameter?.id_token || '';
}
```

### 4. GASã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å³å¯†æ¤œè¨¼ã™ã‚‹
ã“ã®æ§‹æˆã®ä¸­æ ¸ã¯`verifyGoogleIdTokenOrThrow_`ã§ã™ã€‚æ¬¡ã‚’æº€ãŸã•ãªã„å ´åˆã¯å³ã‚¨ãƒ©ãƒ¼ã«ã—ã¾ã™ã€‚

- `id_token`ãŒå­˜åœ¨ã™ã‚‹
- `tokeninfo`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ200
- `iss`ãŒGoogleæ­£è¦å€¤
- `aud`ãŒOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ä¸€è‡´
- `exp`ãŒç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šæœªæ¥
- `email_verified`ãŒtrue
- `AVAILABLE_GMAILS`ã«å«ã¾ã‚Œã‚‹ãƒ¡ãƒ¼ãƒ«ã®ã¿è¨±å¯

```js
// GAS: Code.gs
function verifyGoogleIdTokenOrThrow_(idToken) {
  if (!idToken) {
    throw new Error('missing id token');
  }

  const oauthClientId = getScriptProperty_('GOOGLE_OAUTH_CLIENT_ID');
  if (!oauthClientId) {
    throw new Error('missing GOOGLE_OAUTH_CLIENT_ID');
  }

  const response = UrlFetchApp.fetch(
    `https://oauth2.googleapis.com/tokeninfo?id_token=${encodeURIComponent(idToken)}`,
    { muteHttpExceptions: true },
  );

  if (response.getResponseCode() !== 200) {
    throw new Error('token verification failed');
  }

  const payload = JSON.parse(response.getContentText());
  // iss / aud / exp / email_verified / allowlist ã‚’æ¤œè¨¼
}
```

### 5. `doGet`ã§èªè¨¼ã‚²ãƒ¼ãƒˆã‚’æœ€åˆã«å®Ÿè¡Œã™ã‚‹
`doGet`ã®å…ˆé ­è¿‘ãã§èªè¨¼ã‚’é€šã—ã¦ã‹ã‚‰ã€ãƒ‡ãƒ¼ã‚¿è¿”å´ã¸é€²ã‚ã¾ã™ã€‚ã“ã‚Œã§ã€Œæœªèªè¨¼ã§ãƒ‡ãƒ¼ã‚¿ã¸åˆ°é”ã™ã‚‹çµŒè·¯ã€ã‚’æ½°ã›ã¾ã™ã€‚

```js
// GAS: Code.gs
export function doGet(e) {
  try {
    const parameters = e?.parameter;

    if (!isDebugMode_()) {
      const idToken = extractIdToken_(e);
      verifyGoogleIdTokenOrThrow_(idToken);
    }

    // èªè¨¼OKæ™‚ã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¸
  } catch (error) {
    const message = error?.message || 'unauthorized';
    const status = message === 'forbidden email' ? 403 : 401;
    return createJsonResponse_(JSON.stringify({ status, error: message }));
  }
}
```

ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã¯ã“ã®`401/403`ã‚’`AUTH`ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã„ã€å†ãƒ­ã‚°ã‚¤ãƒ³å°ç·šã¸æˆ»ã—ã¾ã™ã€‚

```js
// src/stores/portfolio.js
if (json?.status === 401 || json?.status === 403) {
  const authMessage = json.error ?? "unauthorized";
  throw new Error(`AUTH ${json.status}: ${authMessage}`);
}
```

---

## è‹¦åŠ´ã—ãŸç‚¹ã¨è§£æ±ºç­–

### è‹¦åŠ´1: OAuthè¨­å®šãƒŸã‚¹ã§`aud`ä¸ä¸€è‡´ãŒç™ºç”Ÿã—ã‚„ã™ã„
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã®å–ã‚Šé•ãˆï¼ˆåˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®IDï¼‰ã§å¤±æ•—ã—ã‚„ã™ã„ã§ã™ã€‚

**è§£æ±ºç­–**
- GASã®`GOOGLE_OAUTH_CLIENT_ID`ã¨ãƒ•ãƒ­ãƒ³ãƒˆã®`VITE_GOOGLE_CLIENT_ID`ã‚’åŒä¸€å€¤ã§ç®¡ç†
- å¤±æ•—æ™‚ã¯GASã§`invalid aud`ã‚’æ˜ç¤ºã—ã¦åŸå› ã‚’è¦‹ãˆã‚‹åŒ–

### è‹¦åŠ´2: è¨±å¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‹ç”¨ãŒå±äººçš„ã«ãªã‚‹
åˆæœŸã¯ã‚³ãƒ¼ãƒ‰ã«ç›´æ›¸ãã—ãŒã¡ã§ã€é‹ç”¨å¤‰æ›´ãŒé¢å€’ã§ã™ã€‚

**è§£æ±ºç­–**
- `AVAILABLE_GMAILS`ã‚’Script Propertiesã§ç®¡ç†
- `a@example.com,b@example.com`å½¢å¼ã§é‹ç”¨ãƒãƒ¼ãƒ ãŒç·¨é›†å¯èƒ½ã«ã™ã‚‹

### è‹¦åŠ´3: DEBUGé‹ç”¨ãŒæœ¬ç•ªã«æ··ã–ã‚‹ãƒªã‚¹ã‚¯
DEBUGãŒ`true`ã®ã¾ã¾ã ã¨èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã«ãªã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚

**è§£æ±ºç­–**
- æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«`DEBUG=false`ã‚’å¿…é ˆåŒ–
- æœ¬ç•ªç”¨/æ¤œè¨¼ç”¨ã§GASãƒ‡ãƒ—ãƒ­ã‚¤ã‚’åˆ†é›¢

---

## ã¾ã¨ã‚
gh-pages + GASã§ã‚‚ã€Google OAuthèªè¨¼ã¯ååˆ†ã«å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã§æ§‹ç¯‰ã§ãã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã¯æ¬¡ã®3ã¤ã§ã™ã€‚

1. **OAuthã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼‰ã‚’å…ˆã«å›ºå®šã™ã‚‹**
2. **GASã§ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚’å³å¯†ã«è¡Œã†**
3. **è¨±å¯ãƒ¡ãƒ¼ãƒ«/DEBUGãªã©é‹ç”¨è¨­å®šã‚’PropertiesåŒ–ã™ã‚‹**

ä»Šå¾Œã¯ã€èªè¨¼ç›£æŸ»ãƒ­ã‚°ã‚„ã‚¢ãƒ©ãƒ¼ãƒˆé€£æºï¼ˆé€£ç¶šå¤±æ•—æ¤œçŸ¥ï¼‰ã‚’è¿½åŠ ã—ã€é‹ç”¨å“è³ªã‚’ã•ã‚‰ã«é«˜ã‚ã‚‹äºˆå®šã§ã™ã€‚
